<div class="d-flex justify-content-center">
  <table class="table table-striped text-center table-sm">
    <thead>
      <tr>
        <th scope="col">#</th>
        <th scope="col">From</th>
        <th scope="col">To</th>
        <th scope="col">Body</th>
        <th scope="col">Sent At</th>
      </tr>
    </thead>
    <tbody>
      <% @sms_logs.each_with_index do |sms_log, index| %>
        <tr>
          <th scope="row"><%= index + 1 %></th>
          <td class="text-center"><%= sms_log.from_number %></td>
          <td class="text-center"><%= sms_log.to_number %></td>
          <td class="text-center"><%= sms_log.body %></td>
          <td class="text-center"><%= sms_log.sent_at.strftime('%Y-%m-%d %H:%M:%S') %></td>
        </tr>
      <% end %>
    </tbody>
  </table>
</div>



<%= button_to 'Enviar SMS', send_sms_path, method: :post %>

<%= button_to 'Enviar SMS Twilio', send_sms_twilio_path, method: :post %>


<%= button_to 'Enviar Mensagem via WhatsApp', send_whatsapp_message_path, method: :post %>


<%= button_to 'Enviar WhatsApp Twilio', send_whatsapp_message_twilio_path, method: :post %>















require 'httparty'
require 'twilio-ruby'

class SmsController < ApplicationController
  def index
    @sms_logs = SmsLog.all
    @sms_template = SmsTemplate.last
  end

  def new
    @sms_template = SmsTemplate.new
  end

  def create
    @sms_template = SmsTemplate.new(sms_template_params)
    if @sms_template.save
      flash[:success] = 'Mensagem padrão criada com sucesso!'
      redirect_to sms_path
    else
      flash[:error] = 'Erro ao criar a mensagem padrão.'
      render :new
    end
  end

  def edit
    @sms_template = SmsTemplate.find(params[:id])
  end

  def update
    @sms_template = SmsTemplate.find(params[:id])
    if @sms_template.update(sms_template_params)
      flash[:success] = 'Mensagem padrão atualizada com sucesso!'
      redirect_to sms_index_path
    else
      flash[:error] = 'Erro ao atualizar a mensagem padrão.'
      render :edit
    end
  end

  def destroy
    @sms_template = SmsTemplate.find(params[:id])
    @sms_template.destroy
    flash[:success] = 'Mensagem padrão apagada com sucesso!'
    redirect_to sms_index_path
  end

  def send_sms_twilio
    account_sid = 'ACcbd199f02e7c1e843cd953a16ac1e714'
    auth_token = '3d1102aa17ee4151b2de70dcce93192c'
    client = Twilio::REST::Client.new(account_sid, auth_token)

    phone_numbers = fetch_phone_numbers_from_api
    if params[:cont].to_i == 80 && phone_numbers.any?
      phone_number = phone_numbers.first['phone']
      send_sms_to_phone(client, phone_number)

      render json: { message: 'SMS enviado automaticamente!' }
    else
      render json: { message: 'SMS nao enviado automaticamente.' }
    end
  end

  private

  def sms_template_params
    params.require(:sms_template).permit(:body)
  end

  def fetch_phone_numbers_from_api
    api_url = 'https://dispenser-smart-api-9ae096adb72b.herokuapp.com/esp8266s'
    headers = {
      'Authorization' => 'Bearer YOUR_API_TOKEN' # Se sua API necessita de um token de autenticação, adicione-o aqui
    }
    
    response = HTTParty.get(api_url, headers: headers)
    if response.success?
      response.parsed_response
    else
      []
    end
  end

  def send_sms_to_phone(client, phone_number)
    from = '5416128239' # Número de telefone fornecido pela Twilio
    body = @sms_template.body # Corpo da mensagem SMS

    #to = '5561992488131' # Número de telefone do destinatário Luis RFID
    #to = '5561998058131'
    #to = '5561995762787' # Número de telefone do destinatário Caio
    #to = '5561993212899' #Caian
    #to = '5561991150833' #Ivanice

    message = client.messages.create(
      from: from,
      to: phone_number,
      body: body
    )

    # Salva o log da mensagem
    sms_log = SmsLog.create(
      from_number: message.from,
      to_number: message.to,
      body: message.body,
      sent_at: Time.now
    )
  rescue Twilio::REST::TwilioError => e
    render json: { error: e.message }, status: :unprocessable_entity
  end
end













<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.0/css/bootstrap.min.css">
<script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.5.4/dist/umd/popper.min.js"></script>
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.0/js/bootstrap.min.js"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.9.4/Chart.min.css">

<!-- Navbar -->
<nav class="navbar navbar-expand-lg navbar-dark bg-dark">
<%= link_to 'Painel Administrativo', admin_index_path, class: 'navbar-brand' %>
  <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarNav"
        aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
    <span class="navbar-toggler-icon"></span>
  </button>
  <div class="collapse navbar-collapse" id="navbarNav">
    <ul class="navbar-nav ml-auto">
      <li class="nav-item dropdown">
        <a class="nav-link dropdown-toggle" href="#" id="navbarDropdownMenuLink" role="button"
          data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
          Opções <i class="fa fa-gear"></i>
        </a>
        <div class="dropdown-menu" aria-labelledby="navbarDropdownMenuLink">
          <a class="dropdown-item" href="#"><%= current_user.name %></a>
          <%= link_to 'Editar', edit_user_registration_path, class: 'dropdown-item' %>
          <%= link_to 'Sair', destroy_user_session_path, method: :delete, class: 'dropdown-item' %>
        </div> 
      </li>
    </ul>
  </div>
</nav>
<!-- /Navbar -->

<div class="container-fluid">
  <div class="row">
    <!-- Sidebar -->
    <div class="col-lg-3">
          <div class="sidebar bg-dark">
              <ul class="list-group">
                  <li class="list-group-item active">Dashboard</li>
                  <li class="list-group-item"><%= link_to 'Home', admin_index_path %></li>
                  <li class="list-group-item"><%= link_to 'Gestão de Usuários', user_management_path %></li>
                  <li class="list-group-item"><%= link_to 'Vizualização de Dispositivos', status_path %></li>
                  <li class="list-group-item"><%= link_to 'Gestão de Dispositivos', devices_path %></li>
                  <li class="list-group-item"><%= link_to 'Status dos Dispositivos', status_path %></li>
                  <li class="list-group-item"><%= link_to 'Configuração de Mensagens', sms_path %></li>
              </ul>
          </div>
    </div>
    <!-- /Sidebar -->
    <div class="col-lg-9">
      <h1 class="mt-4">Configuração de Mensagens</h1>
      <!-- app/views/sms_templates/new.html.erb -->
      <h2>Criar Mensagem Padrão</h2>
      <%= form_for @sms_template, url: sms_path do |f| %>
        <%= f.label :body, "Mensagem:" %>
        <%= f.text_area :body, class: "form-control" %>
        </br>
        <%= f.submit "Salvar", class: "btn btn-primary" %>
      <% end %>
    </div>      
  </div>
</div>
<%= render partial: 'layouts/footer-admin' %>





